// Version-independent interface to the `AMDRadeonX5000_AMDHWAlignManager` class
//
// Copyright Â© 2025 ChefKiss. Licensed under the Thou Shalt Not Profit License version 1.5.
// See LICENSE for details.

#pragma once
#include <GPUDriversAMD/AddrLib.hpp>
#include <Headers/kern_util.hpp>

struct AMDTilingInfo {
    UInt32 tilingConfig;
    UInt32 field_4;
    UInt32 field_8;
    UInt32 field_c;
    UInt32 field_10;
    UInt32 field_14;
    UInt32 field_18;
};

enum struct ATIPixelMode : UInt8 {
    Invalid,
    C_8,
    C_16,
    C_8_8,
    C_32,
    C_16_16,
    C_10_11_11,
    C_11_11_10,
    C_10_10_10_2,
    C_2_10_10_10,
    C_8_8_8_8,
    C_32_32,
    C_16_16_16_16,
    Reserved_13,
    C_32_32_32_32,
    Reserved_15,
    C_5_6_5,
    C_1_5_5_5,
    C_5_5_5_1,
    C_4_4_4_4,
    C_8_24,
    C_24_8,
    C_X24_8_32_FLOAT,
    Reserved_23,
    HW_DEFINED = 0xFF,
};
static_assert(sizeof(ATIPixelMode) == 0x1);

enum struct ATIFormat : UInt8 {
    Null,
    Luminance8,
    Alpha8,
    Intensity8,
    LuminanceAlpha8,
    RGB565,
    BGR565,
    ARGB4,
    BGRA4,
    ABGR4,
    RGBA4,
    ARGB1555,
    ABGR1555,
    RGBA5551,
    BGRA5551,
    BGRA8,
    RGBA8,
    ABGR8,
    ARGB8,
    ARGB8Noswap,
    RGB4S3tc,
    RGBADxt3,
    RGBADxt5,
    LA3DC,
    Red3DC,
    ARGB16161616F = Red3DC,
    SignedRed3DC,
    RG3DC,
    SignedRG3DC,
    Depth16,
    BGRA32F,
    RGBA32F,
    RGBA32U,
    Luminance32F,
    Alpha32F,
    Intensity32F,
    LuminanceAlpha32F,
    BGRA16,
    RGBA16,
    Luminance16,
    Alpha16,
    Intensity16,
    LuminanceAlpha16,
    BGRA16F,
    RGBA16F,
    Luminance16F,
    Alpha16F,
    Intensity16F,
    LuminanceAlpha16F,
    ABGR2101010,
    ARGB2101010,
    RGBA1010102,
    BGRA1010102,
    AVYU444,
    VYUY422,
    YVYU422,
    BGRG422,
    GBGR422,
    RGB332,
    R8,
    R16,
    Rg8,
    Rg16,
    R16F,
    R32F,
    Rg16F,
    Rg32F,
    Depth24Stencil8,
    Depth32,
    Depth32F,
    Depth32fStencil8,
    BGRA32U,
    Alpha32U,
    Intensity32U,
    Luminance32U,
    LuminanceAlpha32U,
    RGBA16U,
    BGRA16U,
    Alpha16U,
    Intensity16U,
    Luminance16U,
    LuminanceAlpha16U,
    ARGB2101010U,
    ABGR2101010U,
    RGBA1010102U,
    BGRA1010102U,
    ARGB8UNoSwap,
    ABGR8U,
    RGBA8U,
    BGRA8U,
    Alpha8U,
    Intensity8U,
    Luminance8U,
    LuminanceAlpha8U,
    RGBA5551U,
    BGRA5551U,
    BGRA4U,
    ABGR4U,
    BGR565U,
    RGB332U,
    R8U,
    R16U,
    R32U,
    Rg8U,
    Rg16U,
    Rg32U,
    RGBA32I,
    BGRA32I,
    Alpha32I,
    Intensity32I,
    Luminance32I,
    LuminanceAlpha32I,
    RGBA16I,
    BGRA16I,
    Alpha16I,
    Intensity16I,
    Luminance16I,
    LuminanceAlpha16I,
    RGBA8I,
    BGRA8I,
    Alpha8I,
    Intensity8I,
    Luminance8I,
    LuminanceAlpha8I,
    R8I,
    R16I,
    R32I,
    RG8I,
    RG16I,
    RG32I,
    R11G11B10Float,
    R9G9B9E5SharedExp,
    R8Snorm,
    Rg8Snorm,
    RGBA8Snorm,
    BGRA8Snorm,
    R16Snorm,
    Rg16Snorm,
    RGBA16Snorm,
    BGRA16Snorm,
    Stencil8,
    RGBBPTCSignedF,
    RGBBPTCUnsignedF,
    RGBABPTCUnorm,
    BGRX8,
    DvdYuv2,
    DvdYuv9,
    DvdYuv12,
    DvdDecode,
    DvdLastDecode,
    None,
};
static_assert(sizeof(ATIFormat) == 0x1);

class AMDRadeonX5000_AMDHWAlignManager {
    public:
    auto getAddrFormat(const ATIPixelMode pixelMode) {
        auto vtable = getMember<void *>(this, 0);
        return getMember<UInt32 (*)(AMDRadeonX5000_AMDHWAlignManager *, ATIPixelMode)>(vtable, 0x1C8)(this, pixelMode);
    }

    IOReturn getSurfaceInfo2(ADDR2_COMPUTE_SURFACE_INFO_INPUT *const input,
        ADDR2_COMPUTE_SURFACE_INFO_OUTPUT *const output) {
        auto vtable = getMember<void *>(this, 0);
        return getMember<IOReturn (*)(AMDRadeonX5000_AMDHWAlignManager *, ADDR2_COMPUTE_SURFACE_INFO_INPUT *,
            ADDR2_COMPUTE_SURFACE_INFO_OUTPUT *)>(vtable, 0x130)(this, input, output);
    }
};
